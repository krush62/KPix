name: KPix Manual Build

on:
  workflow_dispatch:
    inputs:
      build_android_apk:
        description: "Build Android APK"
        type: boolean
        default: true
      build_android_aab:
        description: "Build Android AAB"
        type: boolean
        default: false
      build_windows_package:
        description: "Build Windows Package"
        type: boolean
        default: true
      build_windows_installer:
        description: "Build Windows Installer"
        type: boolean
        default: true
      build_linux_package:
        description: "Build Linux Package"
        type: boolean
        default: true
      build_linux_appimage:
        description: "Build Linux AppImage"
        type: boolean
        default: true
      build_web:
        description: "Build Web Package"
        type: boolean
        default: false
      build_macos_dmg:
        description: "Build MacOS Image"
        type: boolean
        default: false
      create_draft_release:
        description: "Create draft GitHub release"
        type: boolean
        default: false

permissions:
  contents: write

env:
  FLUTTER_VERSION: "3.38.1"
  FLUTTER_CHANNEL: "stable"

jobs:
  setup:
    name: Setup Version & Timestamp
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      timestamp: ${{ steps.build_time.outputs.timestamp }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from pubspec.yaml
        id: extract_version
        run: |
          VERSION=$(grep ^version: pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate build timestamp
        id: build_time
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

  android:
    if: ${{ inputs.build_android_apk || inputs.build_android_aab }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - buildType: apk
            enabled: ${{ inputs.build_android_apk }}
          - buildType: aab
            enabled: ${{ inputs.build_android_aab }}
    env:
      VERSION: ${{ needs.setup.outputs.version }}
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
    steps:
      - name: Skip disabled build type
        if: ${{ !matrix.enabled }}
        run: echo "Skipping disabled build type."

      - name: Checkout
        if: ${{ matrix.enabled }}
        uses: actions/checkout@v4

      - name: Setup Java
        if: ${{ matrix.enabled }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        if: ${{ matrix.enabled }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Cache Pub
        if: ${{ matrix.enabled }}
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-


      - name: Cache Gradle
        if: ${{ matrix.enabled }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Flutter • Dependencies
        if: ${{ matrix.enabled }}
        run: flutter pub get

      - name: Android • Setup signing
        if: ${{ matrix.enabled }}
        shell: bash

        run: |
          # Write keystore from Base64
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > android/app/keystore.jks
          
          # Create key.properties consumed by build.gradle
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=keystore.jks
          EOF
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Android • Build AAB & APK
        if: ${{ matrix.enabled }}
        run: |
          if [ "${{ matrix.buildType }}" = "apk" ]; then
            flutter build apk --release
          else
            flutter build appbundle --release
          fi

      - name: Copy artifact to top-level
        if: ${{ matrix.enabled }}
        run: |
          if [ "${{ matrix.buildType }}" = "apk" ]; then
            FILE=$(find build/app/outputs/flutter-apk -name "*release*.apk" | head -n 1)
            EXT=apk
          else
            FILE=$(find build/app/outputs/bundle -name "*.aab" | head -n 1)
            EXT=aab
          fi

          TOPLEVEL_FILE="KPix-android-${{ matrix.buildType }}-v${{ env.VERSION }}.$EXT"
          cp "$FILE" "$TOPLEVEL_FILE"
          echo "ARTIFACT_FILE=$TOPLEVEL_FILE" >> $GITHUB_ENV

      - name: Upload artifact
        if: ${{ matrix.enabled }}
        uses: actions/upload-artifact@v4
        with:
          name: KPix-android-${{ matrix.buildType }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: ${{ env.ARTIFACT_FILE }}




  desktop:
    if: ${{ inputs.build_windows_package || inputs.build_windows_installer || inputs.build_linux_package || inputs.build_linux_appimage }}
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            enabled: ${{ inputs.build_linux_package || inputs.build_linux_appimage }}
          - os: windows-latest
            platform: windows
            enabled: ${{ inputs.build_windows_package || inputs.build_windows_installer }}
    runs-on: ${{ matrix.os }}
    env:
      VERSION: ${{ needs.setup.outputs.version }}
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
      APPIMAGE_OUTPUT_DIR: LinuxAppImage
      APPIMAGE_PREFIX: KPix-linux-appimage
      LINUX_PACKAGE_PREFIX: KPix-linux-package
      WIN_PACKAGE_PREFIX: KPix-windows-package
      WIN_INSTALLER_PREFIX: KPix-windows-installer
    steps:
      - name: Skip if this platform disabled
        if: ${{ !matrix.enabled }}
        run: echo "Skipping disabled platform."

      - name: Checkout
        if: ${{ matrix.enabled }}
        uses: actions/checkout@v4

      - name: Set up Flutter
        if: ${{ matrix.enabled }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter • Dependencies
        if: ${{ matrix.enabled }}
        run: flutter pub get

      # Linux-specific deps
      - name: Install Linux build deps
        if: ${{ matrix.enabled && matrix.platform == 'linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev

      # Build Linux
      - name: Build • Linux
        if: ${{ matrix.enabled && matrix.platform == 'linux' }}
        run: |          
          flutter build linux --release

      - name: Package Linux Release
        if: ${{ matrix.enabled && matrix.platform == 'linux' && inputs.build_linux_package }}
        env:
          VERSION: ${{ needs.setup.outputs.version }}
          TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
          LINUX_PACKAGE_PREFIX: ${{ env.LINUX_PACKAGE_PREFIX }}
        run: |
          RELEASE_DIR="build/linux/x64/release/bundle"
          ARCHIVE_NAME="${{ env.LINUX_PACKAGE_PREFIX }}-v${{ env.VERSION }}.tar.gz"

          if [ ! -d "$RELEASE_DIR" ]; then
            echo "Release directory $RELEASE_DIR not found!"
            exit 1
          fi

          # Create tar.gz containing the contents of the bundle folder
          tar -czf "$ARCHIVE_NAME" -C "$RELEASE_DIR" .

          echo "Created archive: $ARCHIVE_NAME"

      - name: Upload Linux Package
        if: ${{ matrix.enabled && matrix.platform == 'linux' && inputs.build_linux_package }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.LINUX_PACKAGE_PREFIX }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: ${{ env.LINUX_PACKAGE_PREFIX }}-v${{ env.VERSION }}.tar.gz


      - name: Create Linux AppImage
        if: ${{ matrix.enabled && matrix.platform == 'linux' && inputs.build_linux_appimage }}
        env:
          VERSION: ${{ env.VERSION }}
          TIMESTAMP: ${{ env.TIMESTAMP }}
          APPIMAGE_PREFIX: ${{ env.APPIMAGE_PREFIX }}
          APPIMAGE_OUTPUT_DIR: ${{ env.APPIMAGE_OUTPUT_DIR }}
        run: |
          set -e

          APPIMAGE_TOOL_URL="https://github.com/AppImage/appimagetool/releases/download/continuous"
          APPIMAGE_EXEC="appimagetool-x86_64.AppImage"
          BUNDLE_DIR="build/linux/x64/release/bundle"
          OUTPUT_DIR="${APPIMAGE_OUTPUT_DIR}"
          APPDIR_PATH="KPix.AppDir"
          ICON_PATH="imgs/kpix_icon.png"
          APPRUN_FILE="$OUTPUT_DIR/$APPDIR_PATH/AppRun"
          DESKTOP_FILE="$OUTPUT_DIR/$APPDIR_PATH/KPix.desktop"
          OUTPUT_FILE_NAME="${APPIMAGE_PREFIX}-${VERSION}-x86_64.AppImage"

          if [ ! -d "$BUNDLE_DIR" ]; then
            echo "Error: Bundle directory not found at $BUNDLE_DIR"
            exit 1
          fi

          echo "Creating output directory"
          mkdir -p "$OUTPUT_DIR"

          echo "Downloading appimagetool"
          wget -q "$APPIMAGE_TOOL_URL/$APPIMAGE_EXEC" -O "$OUTPUT_DIR/$APPIMAGE_EXEC"
          chmod +x "$OUTPUT_DIR/$APPIMAGE_EXEC"

          echo "Copying bundle into AppDir"
          rm -rf "$OUTPUT_DIR/$APPDIR_PATH"
          mkdir -p "$OUTPUT_DIR/$APPDIR_PATH"
          cp -r "$BUNDLE_DIR/"* "$OUTPUT_DIR/$APPDIR_PATH/"

          echo "Copying icon"
          cp "$ICON_PATH" "$OUTPUT_DIR/$APPDIR_PATH/kpix.png"

          echo "Creating AppRun"
          cat > "$APPRUN_FILE" << 'EOF'
          #!/bin/sh
          cd "$(dirname "$0")"
          exec ./kpix
          EOF
          chmod +x "$APPRUN_FILE"
          
          echo "Creating .desktop file"
          cat > "$DESKTOP_FILE" << EOF
          [Desktop Entry]
          Version=$VERSION
          Type=Application
          Terminal=false
          Name=KPix
          Comment=KPix is a pixel art editor for still images and animations with a focus on generative color ramps and shading.
          Exec=kpix %u
          Icon=kpix
          Categories=Graphics;
          Keywords=pixelart;
          PrefersNonDefaultGPU=true
          SingleMainWindow=true
          EOF
          
          echo "Creating AppImage package"
          "$OUTPUT_DIR/$APPIMAGE_EXEC" "$OUTPUT_DIR/$APPDIR_PATH" "$OUTPUT_DIR/$OUTPUT_FILE_NAME"
          
          echo "Cleaning up temporary files"
          rm -rf "$OUTPUT_DIR/$APPDIR_PATH"
          rm -f "$OUTPUT_DIR/$APPIMAGE_EXEC" "$OUTPUT_DIR/$APPIMAGE_EXEC".[0-9]*
          
          echo "AppImage created: $OUTPUT_DIR/$OUTPUT_FILE_NAME"

      - name: Upload Linux AppImage
        if: ${{ matrix.enabled && matrix.platform == 'linux' && inputs.build_linux_appimage }}
        env:
          APPIMAGE_PREFIX: ${{ env.APPIMAGE_PREFIX }}
          APPIMAGE_OUTPUT_DIR: ${{ env.APPIMAGE_OUTPUT_DIR }}
          TIMESTAMP: ${{ env.TIMESTAMP }}
          VERSION: ${{ env.VERSION }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APPIMAGE_PREFIX }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: ${{ env.APPIMAGE_OUTPUT_DIR }}/${{ env.APPIMAGE_PREFIX }}-${{ env.VERSION }}-x86_64.AppImage

      # Build Windows
      - name: Build • Windows
        if: ${{ matrix.enabled && matrix.platform == 'windows' }}
        shell: pwsh
        run: |
          Write-Host "Running: flutter build windows --release"
          flutter build windows --release

      #Copy distributables
      - name: Copy distributables
        if: ${{ matrix.enabled && matrix.platform == 'windows' }}
        run: |
          $releaseDir = "build/windows/x64/runner/Release"
          
          if (-Not (Test-Path $releaseDir)) {
            Write-Host "Release folder does not exist. Skipping packaging."
            exit 0
          }
          
          $vcDlls = @(
            "C:\Windows\System32\msvcp140.dll",
            "C:\Windows\System32\msvcp140_1.dll",
            "C:\Windows\System32\msvcp140_2.dll",
            "C:\Windows\System32\vcruntime140.dll",
            "C:\Windows\System32\vcruntime140_1.dll"
          )
          
          foreach ($dll in $vcDlls) {
            if (Test-Path $dll) {
              Copy-Item $dll -Destination $releaseDir -Force
            } else {
              Write-Host "Warning: $dll not found on runner!"
            }
          }



      # Create Windows Package
      - name: Package Windows Release
        if: ${{ matrix.enabled && matrix.platform == 'windows' && inputs.build_windows_package }}
        shell: pwsh
        env:
          VERSION: ${{ needs.setup.outputs.version }}
          TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
          WIN_PACKAGE_PREFIX: ${{ env.WIN_PACKAGE_PREFIX }}
        run: |
          $releaseDir = "build/windows/x64/runner/Release"
          $zipFile = "$env:WIN_PACKAGE_PREFIX-v$env:VERSION.zip"
          
          if (-Not (Test-Path $releaseDir)) {
            Write-Host "Release folder does not exist. Skipping packaging."
            exit 0
          }
        
          $exeDllFiles = Get-ChildItem -Path $releaseDir -File | Where-Object {
            $_.Extension -in ".exe", ".dll"
          } | ForEach-Object { $_.FullName }
        
          $dataFolder = Join-Path $releaseDir "data"
          $pathsToZip = @($exeDllFiles)  # start array
          if (Test-Path $dataFolder) {
            $pathsToZip += $dataFolder
          } else {
            Write-Host "Warning: data folder not found!"
          }
        
          if ($pathsToZip.Count -gt 0) {
            Remove-Item -Force $zipFile -ErrorAction SilentlyContinue
            Compress-Archive -Path $pathsToZip -DestinationPath $zipFile
            Write-Host "Windows artifact created: $zipFile"
          } else {
            Write-Host "No files to zip."
          }



        # Upload Windows Package
      - name: Upload Windows Package Artifact
        if: ${{ matrix.enabled && matrix.platform == 'windows' && inputs.build_windows_package }}
        env:
          WIN_PACKAGE_PREFIX: ${{ env.WIN_PACKAGE_PREFIX }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WIN_PACKAGE_PREFIX }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: ${{ env.WIN_PACKAGE_PREFIX }}-v${{ env.VERSION }}.zip
          if-no-files-found: ignore

      # Install Inno Setup
      - name: Install Inno Setup
        if: ${{ matrix.enabled && matrix.platform == 'windows' && inputs.build_windows_installer }}
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          choco install innosetup -y

      # Build Windows Installer
      - name: Build Windows Installer
        if: ${{ matrix.enabled && matrix.platform == 'windows' && inputs.build_windows_installer }}
        shell: pwsh
        env:
          VERSION: ${{ needs.setup.outputs.version }}
          TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
          WIN_INSTALLER_PREFIX: ${{ env.WIN_INSTALLER_PREFIX }}
        run: |
          $issFile = "release_tools/windows_installer_build.iss"
          $outputDir = "build/windows_installer"
          New-Item -ItemType Directory -Force -Path $outputDir
          
          $outputFile = "$env:WIN_INSTALLER_PREFIX-v$env:VERSION"
          ISCC.exe /O"$outputDir" /F"$outputFile" $issFile

      # Upload Windows Installer
      - name: Upload Windows Installer
        if: ${{ matrix.enabled && matrix.platform == 'windows' && inputs.build_windows_installer }}
        env:
          WIN_INSTALLER_PREFIX: ${{ env.WIN_INSTALLER_PREFIX }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.WIN_INSTALLER_PREFIX }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: build/windows_installer/*.exe
          if-no-files-found: ignore

  web:
    if: ${{ inputs.build_web }}
    needs: setup
    runs-on: ubuntu-latest
    env:
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
      FILE_NAME: KPix-web-v${{ needs.setup.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - run: flutter pub get

      - run: flutter build web --release

      - run: |
          tar -czf ${{ env.FILE_NAME }}.tar.gz -C build/web .

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}-${{ env.TIMESTAMP }}
          path: ${{ env.FILE_NAME }}.tar.gz


  macos:
    if: ${{ inputs.build_macos_dmg }}
    needs: setup
    runs-on: macos-latest
    env:
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
      FILE_NAME: KPix-macos-v${{ needs.setup.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS app
        run: flutter build macos --release

      - name: Generate .icns icon
        run: |
          mkdir icon.iconset
          
          # Source PNG (change path if needed)
          ICON_SRC="imgs/kpix_icon.png"
          
          # Create sizes required for .icns
          sips -z 16 16     "$ICON_SRC" --out icon.iconset/icon_16x16.png
          sips -z 32 32     "$ICON_SRC" --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32     "$ICON_SRC" --out icon.iconset/icon_32x32.png
          sips -z 64 64     "$ICON_SRC" --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128   "$ICON_SRC" --out icon.iconset/icon_128x128.png
          sips -z 256 256   "$ICON_SRC" --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256   "$ICON_SRC" --out icon.iconset/icon_256x256.png
          sips -z 512 512   "$ICON_SRC" --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512   "$ICON_SRC" --out icon.iconset/icon_512x512.png
          
          # Use original PNG for 1024px
          cp "$ICON_SRC" icon.iconset/icon_512x512@2x.png
          
          # Convert to .icns
          iconutil -c icns icon.iconset -o kpix.icns


      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create .dmg installer
        env:
          FILE_NAME: ${{ env.FILE_NAME }}
        run: |
          APP_PATH="build/macos/Build/Products/Release/KPix.app"
          DMG_PATH="build/macos/Build/Products/Release/${FILE_NAME}.dmg"
          
          create-dmg \
            --volname "KPix" \
            --volicon "kpix.icns" \
            --window-pos 200 120 \
            --window-size 1920 1080 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "$DMG_PATH" \
            "$APP_PATH"


      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        env:
          FILE_NAME: ${{ env.FILE_NAME }}
          TIMESTAMP: ${{ env.TIMESTAMP }}
        with:
          name: ${{ env.FILE_NAME }}-${{ env.TIMESTAMP }}
          path: build/macos/Build/Products/Release/*.dmg



  release:
    name: Create Draft GitHub Release
    needs: [ setup, android, desktop ]
    runs-on: ubuntu-latest
    if: ${{ inputs.create_draft_release && (inputs.build_android_apk || inputs.build_android_aab || inputs.build_windows_package || inputs.build_windows_installer || inputs.build_linux_package || inputs.build_linux_appimage || inputs.build_web || inputs.build_macos_dmg) }}

    env:
      VERSION: ${{ needs.setup.outputs.version }}
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f

      - name: Create draft GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: KPix v${{ env.VERSION }}
          draft: true
          prerelease: false
          files: |
            artifacts/**/*.apk
            artifacts/**/*.aab
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
            artifacts/**/*.AppImage
            artifacts/**/*.exe
            artifacts/**/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}