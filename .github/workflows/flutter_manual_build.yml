name: Flutter • Manual Build (Android + Windows + Linux)

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: "Build Android (signed)"
        type: boolean
        default: true
      build_windows:
        description: "Build Windows"
        type: boolean
        default: true
      build_linux:
        description: "Build Linux"
        type: boolean
        default: true
      flavor:
        description: "Flutter flavor (e.g., dev, prod). Leave empty for default."
        required: false
        type: string
        default: ""
      build_number:
        description: "Build number (passed to --build-number)"
        required: false
        type: string
        default: ""

permissions:
  contents: read

env:
  FLUTTER_VERSION: "3.38.1"
  FLUTTER_CHANNEL: "stable"

jobs:
  setup:
    name: Setup Version & Timestamp
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      timestamp: ${{ steps.build_time.outputs.timestamp }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from pubspec.yaml
        id: extract_version
        run: |
          VERSION=$(grep ^version: pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate build timestamp
        id: build_time
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

  android:
    if: ${{ inputs.build_android }}
    needs: setup
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.setup.outputs.version }}
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter • Dependencies
        run: flutter pub get

      # Android signing, builds, upload steps (same as before)
      - name: Android • Build AAB & APK
        run: |
          FLAVOR_ARG=""
          if [ -n "${{ inputs.flavor }}" ]; then
            FLAVOR_ARG="--flavor ${{ inputs.flavor }}"
          fi
          BUILDNUM_ARG=""
          if [ -n "${{ inputs.build_number }}" ]; then
            BUILDNUM_ARG="--build-number ${{ inputs.build_number }}"
          fi
          flutter build appbundle --release $FLAVOR_ARG $BUILDNUM_ARG
          flutter build apk --release $FLAVOR_ARG $BUILDNUM_ARG

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ inputs.flavor || 'default' }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: |
            build/app/outputs/bundle/**/release/*.aab
            build/app/outputs/flutter-apk/*release*.apk

  desktop:
    if: ${{ inputs.build_windows || inputs.build_linux }}
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            enabled: ${{ inputs.build_linux }}
          - os: windows-latest
            platform: windows
            enabled: ${{ inputs.build_windows }}
    runs-on: ${{ matrix.os }}
    env:
      VERSION: ${{ needs.setup.outputs.version }}
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
    steps:
      - name: Skip if this platform disabled
        if: ${{ !matrix.enabled }}
        run: echo "Skipping disabled platform."

      - name: Checkout
        if: ${{ matrix.enabled }}
        uses: actions/checkout@v4

      - name: Set up Flutter
        if: ${{ matrix.enabled }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter • Dependencies
        if: ${{ matrix.enabled }}
        run: flutter pub get

      # Linux-specific deps
      - name: Install Linux build deps
        if: ${{ matrix.enabled && matrix.platform == 'linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev

      # Build Linux
      - name: Build • Linux
        if: ${{ matrix.enabled && matrix.platform == 'linux' }}
        run: |
          FLAVOR_ARG=""
          if [ -n "${{ inputs.flavor }}" ]; then
            FLAVOR_ARG="--flavor ${{ inputs.flavor }}"
          fi
          flutter build linux --release $FLAVOR_ARG

      - name: Upload Linux Artifact
        if: ${{ matrix.enabled && matrix.platform == 'linux' }}
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ inputs.flavor || 'default' }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: build/linux/**/release/*

      # Build Windows
      - name: Build • Windows
        if: ${{ matrix.enabled && matrix.platform == 'windows' }}
        shell: pwsh
        env:
          FLAVOR: ${{ inputs.flavor }}
          BUILD_NUMBER: ${{ inputs.build_number }}
        run: |
          $FLAVOR_ARG = ""
          if ($env:FLAVOR -ne "") { $FLAVOR_ARG = "--flavor $env:FLAVOR" }

          $BUILDNUM_ARG = ""
          if ($env:BUILD_NUMBER -ne "") { $BUILDNUM_ARG = "--build-number $env:BUILD_NUMBER" }

          flutter build windows --release $FLAVOR_ARG $BUILDNUM_ARG

      # Package Windows Release cleanly
      - name: Package Windows Release
        if: ${{ matrix.enabled && matrix.platform == 'windows' }}
        shell: pwsh
        env:
          VERSION: ${{ needs.setup.outputs.version }}
          TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
        run: |
          $releaseDir = "build\windows\runner\Release"
          $zipFile = "kpix-windows-x64-v$env:VERSION-$env:TIMESTAMP.zip"

          $includeExtensions = @(".exe", ".dll", ".pak", ".json", ".ico", ".txt")
          $filesToZip = Get-ChildItem -Path $releaseDir -Recurse | Where-Object {
              $includeExtensions -contains $_.Extension.ToLower()
          }

          if ($filesToZip.Count -gt 0) {
              Remove-Item -Force $zipFile -ErrorAction SilentlyContinue
              Compress-Archive -Path $filesToZip.FullName -DestinationPath $zipFile
              Write-Host "Windows artifact created: $zipFile"
          } else {
              Write-Host "No files to zip!"
          }

      # Upload Windows Artifact
      - name: Upload Windows Artifact
        if: ${{ matrix.enabled && matrix.platform == 'windows' }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ inputs.flavor || 'default' }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: kpix-windows-x64-v${{ env.VERSION }}-${{ env.TIMESTAMP }}.zip
          if-no-files-found: ignore

      # Install Inno Setup
      - name: Install Inno Setup
        if: ${{ matrix.enabled && matrix.platform == 'windows' }}
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          choco install innosetup -y

      # Build Windows Installer
      - name: Build Windows Installer
        if: ${{ matrix.enabled && matrix.platform == 'windows' }}
        shell: pwsh
        env:
          VERSION: ${{ needs.setup.outputs.version }}
          TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
        run: |
          $issFile = "release_tools/windows_installer_build.iss"
          $outputDir = "build/windows_installer"
          New-Item -ItemType Directory -Force -Path $outputDir

          $outputFile = "kpix-windows-installer-v$env:VERSION-$env:TIMESTAMP"
          ISCC.exe /O"$outputDir" /F"$outputFile" $issFile

      # Upload Windows Installer
      - name: Upload Windows Installer
        if: ${{ matrix.enabled && matrix.platform == 'windows' }}
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: build/windows_installer/*.exe
          if-no-files-found: ignore

