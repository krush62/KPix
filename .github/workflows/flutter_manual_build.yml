name: Flutter • Manual Build (Android + Windows + Linux)

on:
  workflow_dispatch:
    inputs:
      build_android_apk:
        description: "Build Android APK"
        type: boolean
        default: true
      build_android_aab:
        description: "Build Android AAB"
        type: boolean
        default: true
      linux_package:
        description: "Build Linux .tar.gz package"
        type: boolean
        default: false
      linux_appimage:
        description: "Build Linux AppImage"
        type: boolean
        default: false
      windows_package:
        description: "Build Windows zip package"
        type: boolean
        default: false
      windows_installer:
        description: "Build Windows installer"
        type: boolean
        default: false

permissions:
  contents: read

env:
  FLUTTER_VERSION: "3.38.1"
  FLUTTER_CHANNEL: "stable"

jobs:
  setup:
    name: Setup Version & Timestamp
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      timestamp: ${{ steps.build_time.outputs.timestamp }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from pubspec.yaml
        id: extract_version
        run: |
          VERSION=$(grep ^version: pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate build timestamp
        id: build_time
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

  android:
    if: ${{ inputs.build_android_apk || inputs.build_android_aab }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - buildType: apk
            enabled: ${{ inputs.build_android_apk }}
          - buildType: aab
            enabled: ${{ inputs.build_android_aab }}
    env:
      VERSION: ${{ needs.setup.outputs.version }}
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
    steps:
      - name: Skip disabled build type
        if: ${{ !matrix.enabled }}
        run: echo "Skipping disabled build type."

      - name: Checkout
        if: ${{ matrix.enabled }}
        uses: actions/checkout@v4

      - name: Setup Java
        if: ${{ matrix.enabled }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        if: ${{ matrix.enabled }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Cache Pub
        if: ${{ matrix.enabled }}
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-


      - name: Cache Gradle
        if: ${{ matrix.enabled }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Flutter • Dependencies
        if: ${{ matrix.enabled }}
        run: flutter pub get

      - name: Android • Setup signing
        if: ${{ matrix.enabled }}
        shell: bash

        run: |
          # Write keystore from Base64
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > android/app/keystore.jks
          
          # Create key.properties consumed by build.gradle
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=keystore.jks
          EOF
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Android • Build AAB & APK
        if: ${{ matrix.enabled }}
        run: |
          if [ "${{ matrix.buildType }}" = "apk" ]; then
            flutter build apk --release
          else
            flutter build appbundle --release
          fi

      - name: Copy artifact to top-level
        if: ${{ matrix.enabled }}
        run: |
          if [ "${{ matrix.buildType }}" = "apk" ]; then
            FILE=$(find build/app/outputs/flutter-apk -name "*release*.apk" | head -n 1)
            EXT=apk
          else
            FILE=$(find build/app/outputs/bundle -name "*.aab" | head -n 1)
            EXT=aab
          fi

          TOPLEVEL_FILE="kpix-android-${{ matrix.buildType }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}.$EXT"
          cp "$FILE" "$TOPLEVEL_FILE"
          echo "ARTIFACT_FILE=$TOPLEVEL_FILE" >> $GITHUB_ENV

      - name: Upload artifact
        if: ${{ matrix.enabled }}
        uses: actions/upload-artifact@v4
        with:
          name: kpix-android-${{ matrix.buildType }}-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: ${{ env.ARTIFACT_FILE }}




  linux:
    if: ${{ inputs.linux_package || inputs.linux_appimage }}
    needs: setup
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.setup.outputs.version }}
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter • Dependencies
        run: flutter pub get

      - name: Flutter • Build Linux
        run: flutter build linux --release

      # -------------------------
      # Linux tar.gz package
      # -------------------------
      - name: Package Linux .tar.gz
        if: ${{ inputs.linux_package }}
        run: |
          RELEASE_DIR="build/linux/x64/release/bundle"
          ARCHIVE_NAME="kpix-linux-v${{ env.VERSION }}-${{ env.TIMESTAMP }}.tar.gz"
          
          if [ ! -d "$RELEASE_DIR" ]; then
            echo "Release directory $RELEASE_DIR not found!"
            exit 1
          fi
          
          tar -czf "$ARCHIVE_NAME" -C "$RELEASE_DIR" .
          echo "Linux tar.gz created: $ARCHIVE_NAME"

      - name: Upload Linux .tar.gz
        if: ${{ inputs.linux_package }}
        uses: actions/upload-artifact@v4
        with:
          name: kpix-linux-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: kpix-linux-v${{ env.VERSION }}-${{ env.TIMESTAMP }}.tar.gz

      # -------------------------
      # Linux AppImage
      # -------------------------
      - name: Create Linux AppImage
        if: ${{ inputs.linux_appimage }}
        run: |
          set -e
          APPIMAGE_TOOL_URL="https://github.com/AppImage/appimagetool/releases/download/continuous"
          APPIMAGE_EXEC="appimagetool-x86_64.AppImage"
          BUNDLE_DIR="build/linux/x64/release/bundle"
          OUTPUT_DIR="release_tools/LinuxAppImage"
          APPDIR_PATH="KPix.AppDir"
          ICON_PATH="imgs/kpix_icon.png"
          APPRUN_FILE="$OUTPUT_DIR/$APPDIR_PATH/AppRun"
          DESKTOP_FILE="$OUTPUT_DIR/$APPDIR_PATH/KPix.desktop"
          OUTPUT_FILE_NAME="KPix-${{ env.VERSION }}-x86_64.AppImage"
          
          mkdir -p "$OUTPUT_DIR"
          wget -q "$APPIMAGE_TOOL_URL/$APPIMAGE_EXEC" -O "$OUTPUT_DIR/$APPIMAGE_EXEC"
          chmod +x "$OUTPUT_DIR/$APPIMAGE_EXEC"
          
          rm -rf "$OUTPUT_DIR/$APPDIR_PATH"
          mkdir -p "$OUTPUT_DIR/$APPDIR_PATH"
          cp -r "$BUNDLE_DIR/"* "$OUTPUT_DIR/$APPDIR_PATH/"
          cp "$ICON_PATH" "$OUTPUT_DIR/$APPDIR_PATH/kpix.png"
          
          cat > "$APPRUN_FILE" << 'EOF'
          #!/bin/sh
          cd "$(dirname "$0")"
          exec ./kpix
          EOF
          chmod +x "$APPRUN_FILE"
          
          cat > "$DESKTOP_FILE" << EOF
          [ Desktop Entry ]
          Version=${{ env.VERSION }}
          Type=Application
          Terminal=false
          Name=KPix
          Comment=KPix is a pixel art editor for still images and animations with a focus on generative color ramps and shading.
          Exec=kpix %u
          Icon=kpix
          Categories=Graphics;
          Keywords=pixelart;
          PrefersNonDefaultGPU=true
          SingleMainWindow=true
          EOF
          
          "$OUTPUT_DIR/$APPIMAGE_EXEC" "$OUTPUT_DIR/$APPDIR_PATH" "$OUTPUT_DIR/$OUTPUT_FILE_NAME"
          rm -rf "$OUTPUT_DIR/$APPDIR_PATH"
          rm -f "$OUTPUT_DIR/$APPIMAGE_EXEC" "$OUTPUT_DIR/$APPIMAGE_EXEC".[0-9]*

      - name: Upload Linux AppImage
        if: ${{ inputs.linux_appimage }}
        uses: actions/upload-artifact@v4
        with:
          name: kpix-linux-appimage-v${{ env.VERSION }}
          path: release_tools/LinuxAppImage/KPix-${{ env.VERSION }}-x86_64.AppImage



  windows:
    if: ${{ inputs.windows_package || inputs.windows_installer }}
    needs: setup
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.setup.outputs.version }}
      TIMESTAMP: ${{ needs.setup.outputs.timestamp }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter • Dependencies
        run: flutter pub get

      - name: Flutter • Build Windows
        shell: pwsh
        run: flutter build windows --release

      # -------------------------
      # Windows zip package
      # -------------------------
      - name: Package Windows Release
        if: ${{ inputs.windows_package }}
        shell: pwsh
        run: |
          $releaseDir = "build\windows\x64\runner\Release"
          $zipFile = "kpix-windows-x64-v${{ env.VERSION }}-${{ env.TIMESTAMP }}.zip"
          
          if (-Not (Test-Path $releaseDir)) { exit 0 }
          
          Compress-Archive -Path "$releaseDir\*" -DestinationPath $zipFile -Force
          Write-Host "Windows zip created: $zipFile"

      - name: Upload Windows zip
        if: ${{ inputs.windows_package }}
        uses: actions/upload-artifact@v4
        with:
          name: kpix-windows-x64-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: kpix-windows-x64-v${{ env.VERSION }}-${{ env.TIMESTAMP }}.zip

      # -------------------------
      # Windows Installer
      # -------------------------
      - name: Install Inno Setup
        if: ${{ inputs.windows_installer }}
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          choco install innosetup -y

      - name: Build Windows Installer
        if: ${{ inputs.windows_installer }}
        shell: pwsh
        run: |
          $issFile = "release_tools/windows_installer_build.iss"
          $outputDir = "build/windows_installer"
          New-Item -ItemType Directory -Force -Path $outputDir
          ISCC.exe /O"$outputDir" /F"kpix-windows-installer-v${{ env.VERSION }}-${{ env.TIMESTAMP }}" $issFile

      - name: Upload Windows Installer
        if: ${{ inputs.windows_installer }}
        uses: actions/upload-artifact@v4
        with:
          name: kpix-windows-installer-v${{ env.VERSION }}-${{ env.TIMESTAMP }}
          path: build/windows_installer/*.exe